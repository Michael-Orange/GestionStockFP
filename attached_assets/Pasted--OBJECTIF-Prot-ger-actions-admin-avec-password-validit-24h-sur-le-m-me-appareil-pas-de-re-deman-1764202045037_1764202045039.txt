# OBJECTIF
Protéger actions admin avec password, validité 24h sur le même appareil (pas de re-demande pendant 24h).

# CONTEXTE
Endpoint POST /api/auth/verify-admin existe déjà backend ✅
Besoin : Modal password avant actions sensibles + cache 24h pour confort admin

# SOLUTION

Frontend : Cache localStorage (validité 24h)
Backend : Session express-session (validité 24h)
Combinaison = Sécurité + UX optimale

# SPÉCIFICATIONS

## 1. Backend - Session 24h (server/index.ts)

express-session déjà installé ✅
SESSION_SECRET déjà dans Secrets ✅

Configuration session :
- Ajouter AVANT registerRoutes()
- session({
    secret: process.env.SESSION_SECRET,
    resave: false,
    saveUninitialized: false,
    cookie: {
      httpOnly: true,
      maxAge: 24 * 60 * 60 * 1000  // 24 heures
    }
  })

TypeScript : Étendre SessionData
declare module 'express-session' {
  interface SessionData {
    adminVerified?: boolean;
    adminVerifiedAt?: number;
  }
}

## 2. Backend - Route verify-admin (server/routes/auth.ts)

Modifier POST /api/auth/verify-admin existant :

Comportement actuel : Vérifie password + retourne success
Modification : Ajouter stockage session

Code :
- Garde validation password actuelle (bcrypt)
- Ajouter après validation réussie :
  req.session.adminVerified = true
  req.session.adminVerifiedAt = Date.now()
- Retourne {success: true, expiresAt: Date.now() + 24h}

Ajouter GET /api/auth/admin-status :
- Vérifie req.session.adminVerified === true
- Vérifie Date.now() - req.session.adminVerifiedAt < 24h
- Retourne {verified: boolean, expiresAt: number}

## 3. Frontend - Hook useAdminAuth (client/src/hooks/useAdminAuth.ts)

État local avec localStorage :
- adminVerifiedUntil : Date stockée dans localStorage
- Clé : "filtreplante_admin_verified_until"

Méthodes :

isAdminVerified() :
- Vérifie localStorage adminVerifiedUntil
- Retourne true si Date.now() < adminVerifiedUntil
- Sinon false

verifyAdminPassword(userId, password) : Promise<boolean>
- Appelle POST /api/auth/verify-admin
- Si success :
  * Calcule expiresAt = Date.now() + 24h
  * Stocke dans localStorage
  * localStorage.setItem("filtreplante_admin_verified_until", expiresAt)
  * Retourne true
- Si fail : Retourne false

requireAdminAccess(action: () => Promise<void>) : Promise<void>
- Si isAdminVerified() === true :
  * Exécute action directement
- Sinon :
  * Affiche modal password
  * Attend vérification
  * Si OK : Exécute action + stocke cache 24h

clearAdminSession() :
- localStorage.removeItem("filtreplante_admin_verified_until")
- Optionnel : Appelle POST /api/auth/logout-admin

## 4. Frontend - Modal password (client/src/components/admin-password-modal.tsx)

Props :
- isOpen : boolean
- onClose : () => void
- onSuccess : () => void
- currentUser : User

État :
- password : string
- error : string | null
- isLoading : boolean

Comportement :
- Form : Input password + Bouton "Valider"
- onChange input : Clear error
- onSubmit :
  * Appelle verifyAdminPassword(currentUser.id, password)
  * Si success : onSuccess() + ferme modal
  * Si fail : Affiche "Mot de passe incorrect"

Design :
- Modal overlay backdrop
- Input type="password" min-h-touch
- Bouton large "Valider" + "Annuler"
- Message erreur rouge si fail

## 5. Frontend - Intégration admin.tsx

Import useAdminAuth :
const { requireAdminAccess, isAdminVerified } = useAdminAuth();

Wrapper actions :

Valider produit :
const handleValidate = async (productId: number) => {
  await requireAdminAccess(async () => {
    await validateMutation.mutateAsync(productId);
  });
};

Modifier produit :
const handleUpdate = async () => {
  await requireAdminAccess(async () => {
    await updateMutation.mutateAsync({...});
  });
};

Supprimer produit :
const handleDelete = async (productId: number) => {
  await requireAdminAccess(async () => {
    await deleteMutation.mutateAsync(productId);
  });
};

Badge admin vérifié (optionnel) :
{isAdminVerified() && (
  <Badge variant="success">
    Admin vérifié (expire dans {formatTimeRemaining()})
  </Badge>
)}

## 6. Persistance 24h

localStorage :
- Persiste entre fermeture/ouverture app
- Persiste entre refresh page
- Spécifique à l'appareil (téléphone)
- Expire automatiquement après 24h

Backend session :
- Double sécurité si localStorage manipulé
- Expire aussi après 24h côté serveur

Combinaison :
- Admin vérifie password → Cache 24h local + session serveur
- Pendant 24h : Aucune re-demande sur cet appareil
- Après 24h : Re-demande automatique

## 7. Sécurité complémentaire (optionnel)

Si paranoia++ :
- Backend vérifie AUSSI session sur routes admin
- Middleware requireAdminSession sur routes sensibles
- Double check : localStorage + session

Pour contexte 5 users confiance : localStorage 24h suffit

# FLUX UTILISATEUR

Scénario 1 : Premier accès admin
1. Admin ouvre app, sélectionne nom
2. Clique "Valider produit"
3. Modal password apparaît
4. Entre password admin
5. Si OK : Produit validé + cache 24h stocké
6. Pendant 24h : Plus de password demandé

Scénario 2 : Actions multiples dans les 24h
1. Admin valide produit A → Pas de password (cache valide)
2. Admin modifie produit B → Pas de password
3. Admin supprime produit C → Pas de password
4. UX fluide ✅

Scénario 3 : Après 24h
1. Admin ouvre app lendemain (>24h)
2. Clique "Valider produit"
3. Modal password réapparaît
4. Entre password → Cache 24h renouvelé

Scénario 4 : Changement d'appareil
1. Admin sur autre téléphone
2. localStorage différent → Pas de cache
3. Modal password demandé
4. Cache 24h créé sur ce nouvel appareil

# RÉSULTAT ATTENDU

Backend :
- Session 24h avec adminVerified flag
- Endpoint GET /api/auth/admin-status
- Modification POST /api/auth/verify-admin (ajoute session)

Frontend :
- Hook useAdminAuth avec localStorage 24h
- Modal AdminPasswordModal
- Wrapper requireAdminAccess dans admin.tsx

UX :
- ✅ Password demandé première fois
- ✅ Cache 24h sur appareil
- ✅ Pas de re-demande pendant 24h
- ✅ Re-demande automatique après expiration

Sécurité :
- ✅ Actions admin protégées
- ✅ Cache local sécurisé (pas manipulable facilement)
- ✅ Session backend double sécurité
- ✅ Expiration automatique 24h

# VALIDATION

Tests :

1. Admin entre password → Actions possibles
2. Refresh page dans les 24h → Pas de re-password
3. Ferme app + rouvre dans les 24h → Pas de re-password
4. Attend 24h01 → Re-demande password
5. User non-admin ne peut pas bypasser (même en changeant localStorage)

Critères succès :
- ✅ Password demandé avant actions admin
- ✅ Cache 24h fonctionne
- ✅ Persiste entre sessions
- ✅ Expire correctement après 24h
- ✅ UX fluide pour admin

# TEMPS ESTIMÉ

Backend session : 20 min
Hook useAdminAuth : 40 min
Modal password : 30 min
Intégration admin.tsx : 30 min
Tests : 20 min

Total : 2h-2h30